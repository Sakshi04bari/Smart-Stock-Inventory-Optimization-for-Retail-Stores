<!-- templates/dashboard.html -->
{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row mb-3">
  <div class="col-md-8">
    <h3>Dashboard</h3>
    <p class="text-muted">Welcome, {{ username }} Â· Role: {{ role }}</p>
  </div>
  <div class="col-md-4 text-end">
    <form method="post" action="{{ url_for('run_forecast') }}">
      <button class="btn btn-success">Run Forecast Now</button>
      <a href="{{ url_for('download_forecast') }}" class="btn btn-outline-primary">Download Latest CSV</a>
    </form>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-4">
    <div class="card p-2">
      <h6>Alerts</h6>
      <p>Total understock: <strong>{{ summary.total_understock }}</strong></p>
      <p>Total overstock: <strong>{{ summary.total_overstock }}</strong></p>
      <a href="{{ url_for('alerts') }}" class="btn btn-sm btn-warning">View details</a>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-2">
      <h6>Top Understock Products</h6>
      <div id="prodBar" style="height:220px"></div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card p-2">
      <h6>Stores with Most Shortages</h6>
      <div id="storeBar" style="height:220px"></div>
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col-12">
    <div class="card p-3">
      <h6>Forecast Preview</h6>
      <div class="table-responsive">
        {{ preview_table | safe }}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Safe parsing of Jinja data into JS
    const prodNames = JSON.parse('{{ prod_names | tojson | safe }}' || '[]');
    const prodCounts = JSON.parse('{{ prod_counts | tojson | safe }}' || '[]');
    const storeLabels = JSON.parse('{{ store_labels | tojson | safe }}' || '[]');
    const storeCounts = JSON.parse('{{ store_counts | tojson | safe }}' || '[]');

    // Plot Top Products Bar
    if (prodNames.length && prodCounts.length) {
        const prodData = [{
            x: prodNames,
            y: prodCounts,
            type: 'bar',
            marker: { color: 'rgb(0,123,255)' }
        }];
        const prodLayout = { margin: { t: 30 }, responsive: true };
        Plotly.newPlot('prodBar', prodData, prodLayout);
    }

    // Plot Stores Shortages Bar
    if (storeLabels.length && storeCounts.length) {
        const storeData = [{
            x: storeLabels,
            y: storeCounts,
            type: 'bar',
            marker: { color: 'rgb(255,99,71)' }
        }];
        const storeLayout = { margin: { t: 30 }, responsive: true };
        Plotly.newPlot('storeBar', storeData, storeLayout);
    }
</script>
{% endblock %}
